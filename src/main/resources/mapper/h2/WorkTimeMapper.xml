<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
  <!--WorkTimeMapperRepositoryとxmlのマッピング-->
<mapper namespace="com.example.repository.WorkTimeMapperRepository">
	
<!--マッピング定義（労働時間）-->
<resultMap type="com.example.domainUser.model.WorkTimeEntity" id="worktime">
	<result column="work_date" property="workDate" />
	<result column="day_of_week_id" property="dayofweekId" />
	<result column="user_id" property="userId" />
	<result column="start_time" property="startTime" />
	<result column="close_time" property="closeTime" />
	<result column="gen_work_time" property="genWorkTime" />
	<result column="rest_time" property="restTime" />
	<result column="act_work_time" property="actWorkTime" />	
	<result column="over_time" property="overTime" />
</resultMap>

<!--出勤時間の登録-->
<update id="insertStartTime">
update  
   m_worktime 
set 
   start_time = #{startTime},
   rest_time = '01:00:00' 
where 
    work_date = #{workDate}
</update>

<!--退勤時間の登録-->
<update id="insertCloseTime">
update  
   m_worktime 
set 
   close_time = #{closeTime},
   gen_work_time = TIMEDIFF(close_time, start_time),
   act_work_time = TIMEDIFF(gen_work_time, rest_time)  
where 
    work_date = #{workDate}
</update>
<!--残業時間の登録-->
<update id="insertOverTime">
update 
   m_worktime 
set 
   over_time =  
  case 
    when TIMEDIFF(act_work_time, '08:00:00') > 0  
    then TIMEDIFF(act_work_time, '08:00:00') 
    else 0 
  end  
where 
  work_date = #{workDate}
</update>

<!--月次の勤怠を取得-->
<select id="findMany" resultType="WorkTimeEntity">
	select * 
	from m_worktime 
	where DATE_FORMAT(work_date, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m');
</select>

<!--前月の月次の勤怠を取得-->
<select id="findManyLastMonth" resultType="WorkTimeEntity">
	select * 
	from m_worktime 
	where DATE_FORMAT(work_date, '%Y-%m') = DATE_FORMAT(NOW() - INTERVAL 1 MONTH, '%Y-%m');
</select>

<!--来月の月次の勤怠を取得-->
<select id="findManyNextMonth" resultType="WorkTimeEntity">
	select * 
	from m_worktime 
	where DATE_FORMAT(work_date, '%Y-%m') = DATE_FORMAT(NOW() + INTERVAL 1 MONTH, '%Y-%m');
</select>

<!--月次勤怠の合計時間を取得-->
<select id="sumWorkTime" resultType="WorkTimeEntity">
	select 
       sum( time_to_sec(act_work_time)) as total_sec,
       sec_to_time(sum( time_to_sec(act_work_time))) as total_time 
    from 
       m_worktime  
    where 
       DATE_FORMAT(work_date, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m');
</select>




</mapper>